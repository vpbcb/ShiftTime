<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Расчет смены</title>

<link rel="manifest" href="manifest.json">

<style>
:root{
  --bg:#f6f7f9;
  --card:#fff;
  --border:#e6e8ee;
  --ctlBorder:#cfd5e1;
  --ink:#111;
  --muted:#5b6474;
  --pillBg:#f0f2f7;
  --accent:#1976d2;

  --titleFs:13.6px;
  --titlePadV:6px;
  --titlePadH:10px;
  --ctlFs:16px;
  --timeFs:18.5px;
  --resultTimeFs:21px;
}

*{ font-family:Arial, sans-serif; box-sizing:border-box; }
body{ margin:0; background:var(--bg); color:var(--ink); }
.wrap{ max-width:720px; margin:auto; padding:14px; }

.card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  margin-bottom:10px;
}

h1{ font-size:20px; margin:0; text-align:center; }

input, button, select{
  padding:10px;
  border-radius:10px;
  border:1px solid var(--ctlBorder);
  background:#fff;
  cursor:pointer;
  font-size:var(--ctlFs);
}

input[type="time"]{
  width:120px;
  font-size:var(--timeFs);
  text-align:center;
}
select.deltaSelect{
  width:120px;
  font-size:var(--timeFs);
  text-align:center;
}

/* Заголовки-подложки */
.fieldTitle{
  display:inline-flex;
  align-items:center;
  justify-content:center;    /* 1) центрируем надпись */
  font-size:var(--titleFs);
  padding:var(--titlePadV) var(--titlePadH);
  border-radius:999px;
  background:var(--pillBg);
  border:1px solid var(--border);
  width:fit-content;
  font-weight:600;
  white-space:nowrap;
}

/* 1) блок вылета: общий (десктоп) */
.depGrid{
  display:grid;
  grid-template-columns: 1fr auto;
  grid-template-areas:
    "title tz"
    "inputs inputs"
    "delta delta";
  gap:8px 10px;
  align-items:center;
}
.depTitle{ grid-area:title; }
.depTz{ grid-area:tz; justify-self:end; }

/* строка: input вылета слева, tz справа (на мобиле) */
.depLine{
  grid-area:inputs;
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:nowrap;
}

/* кнопки МСК/UTC/Local */
.tzGroup{ display:flex; gap:8px; flex-wrap:nowrap; }
.tzBtn{
  font-weight:600;
  padding:6px 10px;
  border-radius:999px;
  font-size:var(--ctlFs);
}
.tzBtn.active{ background:var(--accent); color:#fff; border-color:var(--accent); }

/* режим Flight/Cabin */
.modeButtons{ display:flex; gap:10px; }
.modeBtn{ flex:1; font-weight:600; }
.modeBtn.active{ background:var(--accent); color:#fff; border-color:var(--accent); }

.toggleBtn{ font-weight:600; }

/* анимация Cabin Crew */
#ccBlock{
  overflow:hidden;
  max-height:0;
  opacity:0;
  transform:translateY(-6px);
  transition:max-height 260ms ease, opacity 260ms ease, transform 260ms ease;
}
#ccBlock.open{ max-height:260px; opacity:1; transform:translateY(0); }

/* ===== DELTA раскрытие (как Cabin Crew) ===== */
#deltaFold{
  grid-area:delta;
  overflow:hidden;
  max-height:0;
  opacity:0;
  transform:translateY(-6px);
  transition:max-height 260ms ease, opacity 260ms ease, transform 260ms ease;
}
#deltaFold.open{
  max-height:90px;
  opacity:1;
  transform:translateY(0);
}
.deltaInner{
  display:flex;
  align-items:center;
  gap:8px;
  padding-top:6px;
}

/* ===== РЕЗУЛЬТАТЫ ===== */
.results3{ display:grid; gap:12px; }
@media (min-width:640px){ .results3{ grid-template-columns:1fr 1fr 1fr; } }

.resultCard{
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  background:#fff;
  display:grid;
  grid-template-rows:42px auto;
  text-align:center;
}

.pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  height:32px;
  font-size:var(--titleFs);
  padding:0 10px;
  border-radius:999px;
  background:var(--pillBg);
  border:1px solid var(--border);
  width:fit-content;
  justify-self:center;
  font-weight:600;
  white-space:nowrap;
}

.timesTop{ padding-top:8px; }
.out{ font-size:var(--resultTimeFs); font-weight:700; line-height:1.1; }

.multiTimes{
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:8px;
  align-items:start;
}
.mtCol{ display:flex; flex-direction:column; align-items:center; gap:4px; }
.mtTime{ font-size:var(--resultTimeFs); font-weight:700; line-height:1.1; }
.mtLbl{ font-size:14px; color:var(--muted); }

/* 6)+LDT */
.sixRow{ display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:start; }

/* ======= ТОЛЬКО ВЕРТИКАЛЬНАЯ ОРИЕНТАЦИЯ / МОБИЛЬНЫЙ ПОРТРЕТ ======= */
@media (max-width:639px){

  /* 1) Подложка 1) на всю ширину как у 2) */
  .fieldTitle.fullTitle{ width:100%; justify-self:stretch; }

  /* 1) Перестраиваем 1): заголовок full, далее строка input+tz, далее delta ниже */
  .depGrid{
    grid-template-columns: 1fr auto;
    grid-template-areas:
      "title title"
      "inputs tz"
      "delta delta";
    align-items:center;
  }
  .depTitle{ width:100%; justify-self:stretch; } /* 1) full ширина */
  .depLine{ justify-self:start; }
  .depTz{ align-self:center; }

  /* 2) Кнопки по размеру как заголовок */
  .tzBtn, .modeBtn, .toggleBtn{
    padding:var(--titlePadV) var(--titlePadH);
    border-radius:999px;
    font-size:var(--titleFs);
  }

  /* 6) Подложка 2) на всю ширину */
  .fieldTitle.fullTitle{ width:100%; justify-self:stretch; }

  /* пары 3/7 и 4/5 */
  .pairRow{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  .halfTitle{ width:100%; justify-self:stretch; display:flex; }
  .halfBlock{ display:grid; gap:10px; }

  /* результаты друг под другом */
  .results3{ grid-template-columns:1fr; }

  /* полноширинные подложки в результатах */
  .resultCard .pill.fullPill{ width:100%; justify-self:stretch; }

  /* 3) уменьшить высоту блока "Продолжительность смены" */
  .resultCard.durationCard{
    padding:8px 10px;             /* меньше вертикальные отступы */
    grid-template-rows:36px auto; /* меньше высота шапки */
  }
  .resultCard.durationCard .pill{
    height:28px;                  /* чуть ниже pill только в этом блоке */
  }
  .resultCard.durationCard .timesTop{
    padding-top:6px;
  }

  /* 6) и LDT вертикально */
  .sixRow{ grid-template-columns:1fr; }
  .pill.fullPill{ width:100%; justify-self:stretch; }

  /* 6) в одну линию: заголовок (2 строки) слева, input справа */
  .sixInline{
    display:grid;
    grid-template-columns:1fr auto;
    gap:10px;
    align-items:stretch;
  }
  .fieldTitle.wrap2{
    white-space:normal;
    line-height:1.15;
    height:42px;           /* высота как у input */
    border-radius:12px;
    width:100%;
  }
  .sixInline input[type="time"]{
    height:42px;
    padding-top:0;
    padding-bottom:0;
  }
}

@media (max-width:360px){
  input[type="time"], select.deltaSelect{ width:110px; }
}
</style>
</head>

<body>
<div class="wrap">

<div class="card">
  <h1>Расчет смены</h1>
</div>

<div class="card">

  <!-- 1) -->
  <div class="depGrid">
    <!-- 1) fullTitle на мобиле, как у 2) -->
    <span class="fieldTitle depTitle fullTitle">1) Время вылета по расписанию</span>

    <!-- tz на мобиле стоит справа от input (за счет grid areas) -->
    <div class="tzGroup depTz" aria-label="Часовой пояс">
      <button type="button" id="btnMSK" class="tzBtn active" onclick="setTzMode('MSK')">МСК</button>
      <button type="button" id="btnUTC" class="tzBtn" onclick="setTzMode('UTC')">UTC</button>
      <button type="button" id="btnLOCAL" class="tzBtn" onclick="setTzMode('LOCAL')">Local</button>
    </div>

    <!-- input вылета -->
    <div class="depLine">
      <input id="depTime" type="time" value="05:00" step="60">
    </div>

    <!-- Δ UTC раскрывается НИЖЕ input -->
    <div id="deltaFold">
      <div class="deltaInner">
        <span class="fieldTitle">Δ UTC?</span>
        <select id="deltaUtc" class="deltaSelect">
          <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="8">8</option><option value="9">9</option>
          <option value="10">10</option><option value="11">11</option><option value="12">12</option>
        </select>
      </div>
    </div>
  </div>

  <!-- 2) -->
  <div style="margin-top:12px;">
    <div class="fieldTitle fullTitle">2) Расчет для</div>
    <div class="modeButtons" style="margin-top:10px;">
      <button type="button" id="btnFlight" class="modeBtn active" onclick="setCrew('flight')">Flight Crew</button>
      <button type="button" id="btnCabin" class="modeBtn" onclick="setCrew('cabin')">Cabin Crew</button>
    </div>
  </div>

  <!-- 3) и 7) -->
  <div id="ccBlock" style="margin-top:12px;">
    <div class="pairRow">
      <div class="halfBlock">
        <div class="fieldTitle halfTitle">3) Аэропорт явки</div>
        <button type="button" id="airportBtn" class="toggleBtn" onclick="toggleAirport()">UUEE</button>
      </div>

      <div class="halfBlock">
        <div class="fieldTitle halfTitle">7) Усиленный экипаж?</div>
        <button type="button" id="reinforcedBtn" class="toggleBtn" onclick="toggleReinforced()">Нет</button>
      </div>
    </div>
  </div>

  <!-- 4) и 5) -->
  <div style="margin-top:12px;">
    <div class="pairRow">
      <div class="halfBlock">
        <div class="fieldTitle halfTitle">4) Кол-во посадок</div>
        <button type="button" id="landingsBtn" class="toggleBtn" onclick="toggleLandings()">1–2</button>
      </div>

      <div class="halfBlock">
        <div class="fieldTitle halfTitle">5) Продление КВС?</div>
        <button type="button" id="extendBtn" class="toggleBtn" onclick="toggleExtend()">Нет</button>
      </div>
    </div>
  </div>

</div>

<!-- Результаты -->
<div class="card">
  <div class="results3">

    <div class="resultCard durationCard">
      <div class="pill fullPill">Продолжительность смены</div>
      <div class="timesTop" style="display:flex; justify-content:center;">
        <div class="out" id="outDuration">—</div>
      </div>
    </div>

    <div class="resultCard">
      <div class="pill fullPill">Выключение двигателей</div>
      <div class="timesTop">
        <div class="multiTimes">
          <div class="mtCol"><div class="mtTime" id="outEngMSK">—</div><div class="mtLbl">МСК</div></div>
          <div class="mtCol"><div class="mtTime" id="outEngUTC">—</div><div class="mtLbl">UTC</div></div>
          <div class="mtCol"><div class="mtTime" id="outEngLOC">—</div><div class="mtLbl">Local</div></div>
        </div>
      </div>
    </div>

    <div class="resultCard">
      <div class="pill fullPill">Окончание смены</div>
      <div class="timesTop">
        <div class="multiTimes">
          <div class="mtCol"><div class="mtTime" id="outEndMSK">—</div><div class="mtLbl">МСК</div></div>
          <div class="mtCol"><div class="mtTime" id="outEndUTC">—</div><div class="mtLbl">UTC</div></div>
          <div class="mtCol"><div class="mtTime" id="outEndLOC">—</div><div class="mtLbl">Local</div></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- 6) + LDT -->
<div class="card">
  <div class="sixRow">

    <div>
      <div class="sixInline">
        <div class="fieldTitle fullTitle wrap2">6) Время на<br>обратный полет</div>
        <input id="flightTime" type="time" value="02:30" step="60">
      </div>
    </div>

    <div>
      <div class="pill fullPill">LDT</div>
      <div class="timesTop">
        <div class="multiTimes">
          <div class="mtCol"><div class="mtTime" id="outLdtMSK">—</div><div class="mtLbl">МСК</div></div>
          <div class="mtCol"><div class="mtTime" id="outLdtUTC">—</div><div class="mtLbl">UTC</div></div>
          <div class="mtCol"><div class="mtTime" id="outLdtLOC">—</div><div class="mtLbl">Local</div></div>
        </div>
      </div>
    </div>

  </div>
</div>

</div>

<script>
let cabincrew="нет", airport="UUEE", reinforced="нет", landings="1-2", extend="нет";
let tzMode = "MSK"; // MSK | UTC | LOCAL

function setTzMode(mode){
  tzMode = mode;

  btnMSK.classList.toggle("active", tzMode==="MSK");
  btnUTC.classList.toggle("active", tzMode==="UTC");
  btnLOCAL.classList.toggle("active", tzMode==="LOCAL");

  // 2) Δ UTC раскрывается под временем вылета с анимацией
  if(tzMode==="LOCAL") deltaFold.classList.add("open");
  else deltaFold.classList.remove("open");

  render();
}

function setCrew(type){
  cabincrew=(type==="cabin")?"да":"нет";
  btnFlight.classList.toggle("active",cabincrew==="нет");
  btnCabin.classList.toggle("active",cabincrew==="да");

  if(cabincrew==="да") ccBlock.classList.add("open");
  else ccBlock.classList.remove("open");

  if(cabincrew==="нет"){
    airport="UUEE"; reinforced="нет";
    airportBtn.textContent="UUEE";
    reinforcedBtn.textContent="Нет";
  }
  render();
}

function toggleAirport(){ airport=airport==="UUEE"?"другой":"UUEE"; airportBtn.textContent=airport; render(); }
function toggleReinforced(){ reinforced=reinforced==="нет"?"да":"нет"; reinforcedBtn.textContent=reinforced==="да"?"Да":"Нет"; render(); }
function toggleLandings(){ landings=landings==="1-2"?"3-4":"1-2"; landingsBtn.textContent=landings==="1-2"?"1–2":"3–4"; render(); }
function toggleExtend(){ extend=extend==="нет"?"да":"нет"; extendBtn.textContent=extend==="да"?"Да":"Нет"; render(); }

function parseTime(t){ if(!t) return null; const [a,b]=t.split(":").map(Number); return a*60+b; }
function fmt(m){ m=(m+1440)%1440; return String(Math.floor(m/60)).padStart(2,"0")+":"+String(m%60).padStart(2,"0"); }

/* Конвертация:
   База расчетов — МСК.
   MSK = UTC + 3
   Local = UTC + Δ (Δ 1..12)
*/
function getDeltaHours(){
  const v = Number(deltaUtc?.value || 3);
  return Number.isFinite(v) ? v : 3;
}
function toMskMinutes(inputMinutes){
  const delta = getDeltaHours();
  if(tzMode==="MSK") return inputMinutes;
  if(tzMode==="UTC") return inputMinutes + 3*60;
  return inputMinutes + (3 - delta)*60; // LOCAL -> MSK
}
function mskToUtc(mskMinutes){ return mskMinutes - 3*60; }
function mskToLocal(mskMinutes){
  const delta = getDeltaHours();
  return mskToUtc(mskMinutes) + delta*60;
}

function calculate(){
  const depInput=parseTime(depTime.value);
  const flt=parseTime(flightTime.value);
  if(depInput==null||flt==null) return null;

  const dep = toMskMinutes(depInput);

  const checkIn = dep - ((cabincrew==="да" && airport==="UUEE") ? 90 : 60);
  const isDay = checkIn>=361 && checkIn<=1319;

  let norm=null;
  if(cabincrew==="да" && reinforced==="да"){
    norm = (landings==="1-2") ? (extend==="да"?960:780) : (extend==="да"?900:720);
  } else {
    if(landings==="1-2") norm = isDay ? (extend==="да"?840:720) : (extend==="да"?780:660);
    if(landings==="3-4") norm = isDay ? (extend==="да"?750:630) : (extend==="да"?720:600);
  }
  if(!norm) return null;

  const end = checkIn + norm;
  return {
    duration: end - checkIn,
    eng_msk: end - 30,
    end_msk: end,
    ldt_msk: end - 30 - flt
  };
}

function render(){
  const r=calculate();
  if(!r){
    outDuration.textContent="—";
    outEngMSK.textContent="—"; outEngUTC.textContent="—"; outEngLOC.textContent="—";
    outEndMSK.textContent="—"; outEndUTC.textContent="—"; outEndLOC.textContent="—";
    outLdtMSK.textContent="—"; outLdtUTC.textContent="—"; outLdtLOC.textContent="—";
    return;
  }

  outDuration.textContent = fmt(r.duration);

  outEngMSK.textContent = fmt(r.eng_msk);
  outEngUTC.textContent = fmt(mskToUtc(r.eng_msk));
  outEngLOC.textContent = fmt(mskToLocal(r.eng_msk));

  outEndMSK.textContent = fmt(r.end_msk);
  outEndUTC.textContent = fmt(mskToUtc(r.end_msk));
  outEndLOC.textContent = fmt(mskToLocal(r.end_msk));

  outLdtMSK.textContent = fmt(r.ldt_msk);
  outLdtUTC.textContent = fmt(mskToUtc(r.ldt_msk));
  outLdtLOC.textContent = fmt(mskToLocal(r.ldt_msk));
}

/* моментальный пересчет */
let lastDep=depTime.value, lastFlt=flightTime.value;
let lastTz=tzMode, lastDelta=(deltaUtc?deltaUtc.value:"3");
setInterval(()=>{
  const d = (window.deltaUtc ? deltaUtc.value : "3");
  if(depTime.value!==lastDep || flightTime.value!==lastFlt || tzMode!==lastTz || d!==lastDelta){
    lastDep=depTime.value; lastFlt=flightTime.value; lastTz=tzMode; lastDelta=d;
    render();
  }
},150);

/* старт */
ccBlock.classList.remove("open");
setTzMode("MSK");   // это же закроет deltaFold
render();
</script>
</body>
</html>
